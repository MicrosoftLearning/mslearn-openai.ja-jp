---
lab:
  title: Azure OpenAI で独自のデータを使用する
---

# Azure OpenAI で独自のデータを使用する

Azure OpenAI Service を使用すると、基になる LLM のインテリジェンスで独自のデータを使用できます。 独自のデータのみを関連トピックに使用するようにモデルを制限したり、事前トレーニング済みモデルの結果とブレンドしたりすることができます。

この演習には約 **20** 分かかります。

## 開始する前に

Azure OpenAI Service へのアクセスが承認されている Azure サブスクリプションが必要になります。 

- 無料の Azure サブスクリプションにサインアップするには、[https://azure.microsoft.com/free](https://azure.microsoft.com/free) にアクセスしてください。
- Azure OpenAI Service へのアクセスを要求するには、[https://aka.ms/oaiapply](https://aka.ms/oaiapply) にアクセスしてください。

## Azure OpenAI リソースをプロビジョニングする

Azure OpenAI モデルを使用する前に、Azure サブスクリプションに Azure OpenAI リソースをプロビジョニングする必要があります。

1. [Azure portal](https://portal.azure.com?azure-portal=true) にサインインします。
2. 次の設定で **Azure OpenAI** リソースを作成します。
    - **サブスクリプション**: Azure OpenAI Service のアクセスが承認されている Azure サブスクリプション。
    - **リソース グループ**: 既存のリソース グループを選択するか、任意の名前を使用して新規に作成します。
    - **リージョン**: 使用できるリージョンを選択します。
    - **名前**: 任意の一意の名前。
    - **価格レベル**: Standard S0
3. デプロイが完了するまで待ちます。 次に、Azure portal でデプロイされた Azure OpenAI リソースに移動します。

## モデルをデプロイする

Azure OpenAI とチャットするには、まず、**Azure OpenAI Studio** を介して使用するモデルをデプロイする必要があります。 デプロイが完了したら、モデルをプレイグラウンドで使用し、データを応答の根拠付けに使用します。

1. Azure OpenAI リソースの **[概要]** ページで、 **[探索]** ボタンを使用して、新しいブラウザー タブで Azure OpenAI Studio を開きます。または、[Azure OpenAI Studio](https://oai.azure.com/?azure-portal=true) に直接移動します。
2. Azure OpenAI Studio の [**デプロイ**] ページで、既存のモデルのデプロイを表示します。 まだデプロイがない場合は、次の設定で **gpt-35-turbo-16k** モデルの新しいデプロイを作成します。
    - **モデル**: gpt-35-turbo-16k
    - **モデル バージョン**: 既定値に自動更新
    - **デプロイの名前**: *任意の一意の名前*
    - **詳細オプション**
        - **コンテンツ フィルター**: 既定
        - **1 分あたりのトークンのレート制限**: 5K\*
        - **動的クォータを有効にする**: 有効

    > \* この演習は、1 分あたり 5,000 トークンのレート制限内で余裕を持って完了できます。またこの制限によって、同じサブスクリプションを使用する他のユーザーのために容量を残すこともできます。

> **注**: 一部のリージョンでは、新しいモデル デプロイ インターフェイスに [**モデル バージョン**] オプションが表示されません。 この場合は、オプションを設定せずにそのまま続行してください

## 独自のデータを追加せずに、通常のチャット動作を確認する

Azure OpenAI を独自のデータに接続する前に、まず、基本モデルが、根拠となるデータなしでクエリに応答する方法を確認します。

1. [**チャット**] プレイグラウンドに移動し、デプロイしたモデルが [**構成**] ウィンドウで選択されていることを確認します (デプロイしたモデルが 1 つのみの場合、これが既定になります)。
1. 次のプロンプトを入力して、出力を確認します。

    ```code
    I'd like to take a trip to New York. Where should I stay?
    ```

    ```code
    What are some facts about New York?
    ```

1. 根拠となるデータに含める他の場所 (ロンドン、サンフランシスコなど) についても、観光や滞在場所に関する同様の質問を試します。 地域や近隣地域に関する完全な応答、およびその都市に関する一般的な事実が返されるでしょう。

## チャット プレイグラウンドで独自のデータを接続する

次に、チャット プレイグラウンドに独自のデータを追加して、そのデータを根拠としてどのような応答が返されるかを確認します

1. GitHub から、使用する[データをダウンロード](https://aka.ms/own-data-brochures)します。 提供された `.zip` 内の PDF を抽出します。
1. **[チャット]** プレイグラウンドに移動し、[アシスタントのセットアップ] ペインで [Add your data](独自のデータの追加) を選択します。**
1. **[データ ソースの追加]** を選択し、ドロップダウンから [ファイルのアップロード] を選択します。**
1. ストレージ アカウントと Azure Cognitive Search リソースを作成する必要があります。 ストレージ リソースのドロップダウンで、 **[新しい Azure BLOB ストレージ リソースの作成]** を選択し、次の設定でストレージ アカウントを作成します。 指定されていない設定はすべて、既定値のままにします。

    - **サブスクリプション**: "Azure OpenAI リソースと同じサブスクリプション"**
    - **リソース グループ**: "Azure OpenAI リソースと同じリソース グループ"**
    - **ストレージ アカウント名**: "グローバルに一意の名前を入力します"**
    - **リージョン**: "Azure OpenAI リソースと同じリージョン"**
    - **冗長**: ローカル冗長ストレージ (LRS)

1. リソースが作成されたら、Azure OpenAI Studio に戻り、 **[新しい Azure Cognitive Search リソースの作成]** を選択して次の設定で作成します。 指定されていない設定はすべて、既定値のままにします。

    - **サブスクリプション**: "Azure OpenAI リソースと同じサブスクリプション"**
    - **リソース グループ**: "Azure OpenAI リソースと同じリソース グループ"**
    - **サービス名**: "グローバルに一意の名前を入力します"**
    - **場所**: "Azure OpenAI リソースと同じ場所"**
    - **価格レベル**: Basic

1. 検索リソースがデプロイされるまで待ってから、Azure AI Studio に戻り、ページを更新します。
1. **[データの追加]** で、データ ソースに関する次の値を入力し、 **[次へ]** を選択します。

    - **データ ソースの選択**: ファイルのアップロード
    - **Azure Blob ストレージ リソースの選択**: "作成したストレージ リソースを選択します"**
        - プロンプトが表示されたら CORS を有効にします
    - **Azure Cognitive Search リソースの選択**: "作成した検索リソースを選択します"**
    - **インデックス名の入力**: margiestravel
    - **Add vector search to this search resource (この検索リソースにベクトル検索を追加する)** : オフ
    - **I acknowledge that connecting to an Azure Cognitive Search account will incur usage to my account (Azure Cognitive Search アカウントに接続すると、自分のアカウントに対して使用料が発生することに同意します)** : オン

1. **[ファイルのアップロード]** ページで、ダウンロードした PDF をアップロードし、 **[次へ]** を選択します。
1. **[データ管理]** ページで、ドロップダウンから **[キーワード]** の検索の種類を選択し、 **[次へ]** を選択します。
1. **[レビューと完了]** ページで **[保存して閉じる]** を選択すると、データが追加されます。 これには数分かかる場合があります。その間、ウィンドウを開いたままにしておく必要があります。 完了すると、 **[アシスタントのセットアップ]** ペインで指定したデータ ソース、検索リソース、インデックスが表示されます。

## 独自のデータを根拠とするモデルとチャットする

データを追加したので、前と同じ質問をして、応答がどのように異なるかを確認します。

```
I'd like to take a trip to New York. Where should I stay?
```

```
What are some facts about New York?
```

特定のホテルに関する詳細や Margie's Travel への言及、提供された情報の出所への言及など、今度の応答はまったく異なることに気付くでしょう。 応答で一覧表示されている PDF 形式のリファレンスを開くと、ホテルが、モデルによって提示されたものと同じであることがわかります。

根拠となるデータに含まれる他の都市 (ドバイ、ラスベガス、ロンドン、サンフランシスコ) についても質問してみましょう。

> **注**: **[Add your data](独自のデータの追加)** はまだプレビュー段階であり、この機能は必ずしも期待どおりに動作するとは限りません。たとえば、根拠となるデータに含まれていない都市については、提供される参考情報が正しくない場合があります。

## アプリを独自のデータに接続する

次に、アプリを接続して独自のデータを使用する方法について説明します。

### Cloud Shell でアプリケーションを設定する

Azure OpenAI アプリを独自のデータに接続する方法を示すために、Azure 上の Cloud Shell で実行される短いコマンドライン アプリケーションを使用します。 Cloud Shell を操作するには、新しいブラウザー タブを開きます。

1. [Azure portal](https://portal.azure.com?azure-portal=true) で、ページ上部の検索ボックスの右側にある **[>_]** (*Cloud Shell*) ボタンを選択します。 ポータルの下部に Cloud Shell ペインが開きます。

    ![上部の検索ボックスの右側にあるアイコンをクリックして Cloud Shell を開始している状態のスクリーンショット。](../media/cloudshell-launch-portal.png#lightbox)

2. Cloud Shell を初めて開くと、使用するシェルの種類 (*Bash* または *PowerShell*) を選択するように求められる場合があります。 **[Bash]** を選択します。 このオプションが表示されない場合は、この手順をスキップします。  

3. Cloud Shell 用のストレージを作成するように求められたら、 **[詳細設定の表示]** を選び、次の設定を選びます。
    - **[サブスクリプション]**: 自分のサブスクリプション
    - **Cloud Shell リージョン**: 使用できるリージョンを選びます
    - **Show VNET isolation setings (VNET 分離の設定を表示する)** : オフ
    - **リソース グループ**: Azure OpenAI リソースをプロビジョニングした既存のリソース グループを使います
    - **ストレージ アカウント**: 一意の名前で新しいストレージ アカウントを作成します
    - **ファイル共有**: 一意の名前で新しいファイル共有を作成します

    その後、ストレージが作成されるのを 1 分程度待ちます。

    > **注**: Azure サブスクリプションに既に Cloud Shell を設定している場合は、⚙️ メニューの **[ユーザー設定のリセット]** オプションを使用して、最新バージョンの Python と .NET Framework がインストールされていることを確かめる必要がある場合があります。

4. Cloud Shell ペインの左上に表示されるシェルの種類が *Bash* であることを確認します。 *PowerShell* の場合は、ドロップダウン メニューを使用して *Bash* に切り替えます。

5. ターミナルが起動したら、次のコマンドを入力してサンプル アプリケーションをダウンロードし、`azure-openai` という名前のフォルダーに保存します。

    ```bash
    rm -r azure-openai -f
    git clone https://github.com/MicrosoftLearning/mslearn-openai azure-openai
    ```

6. ファイルは、**azure-openai** という名前のフォルダーにダウンロードされます。 次のコマンドを使用して、この演習のラボ ファイルに移動します。

    ```bash
    cd azure-openai/Labfiles/06-use-own-data
    ```

7. 次のコマンドを実行して、組み込みのコード エディターを開きます。

    ```bash
    code .
    ```

    > **ヒント**: Azure Cloud Shell コード エディターを使用して Azure Cloud Shell 環境でファイルを操作する方法の詳細については、[Azure Cloud Shell コード エディターのドキュメント](https://learn.microsoft.com/azure/cloud-shell/using-cloud-shell-editor)を参照してください。

## アプリケーションの作成

この演習では、Azure OpenAI リソースの使用を有効にするために、アプリケーションのいくつかの重要な部分を完成します。 C# と Python の両方のアプリケーションが提供されています。 どちらのアプリにも同じ機能があります。

1. コード エディターで、言語の設定に応じて **CSharp** または **Python** フォルダーを展開します。

2. 言語の構成ファイルを開きます。

    - C#: `appsettings.json`
    - Python: `.env`
    
3. 次を含めて構成値を更新します。
    - 作成した Azure OpenAI リソースの**エンドポイント**と**キー** (Azure Portal の Azure OpenAI リソースの [**キーとエンドポイント**] ページで使用できます)
    - モデルのデプロイに指定した名前 (Azure OpenAI Studio の [**デプロイ**] ページで使用できます)。
    - 検索サービスのエンドポイント (Azure Portal の検索リソースの概要ページの **URL** 値)。
    - 検索リソースの**キー** (Azure Portal の検索リソースの [**キー**] ページで使用できます。管理者キーのいずれかを使用できます)。
    - 検索インデックスの名前 (`margiestravel` になります)。
    
4. 更新した構成ファイルを保存します。

5. コンソール ウィンドウで次のコマンドを入力して、優先言語のフォルダーに移動し、必要なパッケージをインストールします。

    **C#**

    ```bash
    cd CSharp
    dotnet add package Azure.AI.OpenAI --version 1.0.0-beta.9
    ```

    **Python**

    ```bash
    cd Python
    pip install python-dotenv
    pip install openai==1.2.0
    ```

6. コード エディターで任意の言語のフォルダーに移動し、コード ファイルを選択して、必要なライブラリを追加します。

    **C#**: OwnData.cs

    ```csharp
    // Add Azure OpenAI package
    using Azure.AI.OpenAI;
    ```

    **Python**: ownData.py

    ```python
    # Add OpenAI import
    from openai import AzureOpenAI
    ```

7. コード ファイルを確認します。特に、API 呼び出しのパラメーターを完了するときに検索値が使用されている場所を確認してください。

## アプリケーションを実行する

アプリが構成されたので、それを実行してモデルに要求を送信し、応答を確認します。 Studio エクスペリエンスと同様に、応答がデータに基づいていることがわかります。

1. Cloud Shell bash ターミナルで、選択した言語のフォルダーに移動します。
1. ターミナルを拡張してブラウザー ウィンドウのほぼ全体に表示されるようにして、アプリケーションを実行します。

    - **C#** : `dotnet run`
    - **Python**: `python ownData.py`

1. プロンプト `Tell me about London` を送信すると、データを参照する応答が表示されます。

## クリーンアップ

Azure OpenAI リソースでの作業が完了したら、[Azure portal](https://portal.azure.com/?azure-portal=true) 内のリソースを必ず削除してください。 これには、ストレージ アカウントと検索リソースも含まれます。これらによって比較的多額のコストが発生する可能性があるため、必ず削除してください。
